<!doctype html>
<html>
<head>
        <title>nc99 JavaScript</title>
        <link href='http://fonts.googleapis.com/css?family=Anonymous+Pro' rel='stylesheet' type='text/css'>
        <link href='http://fonts.googleapis.com/css?family=Source+Code+Pro' rel='stylesheet' type='text/css'>
        <link href='Stylesheets/main.css' rel='stylesheet' type='text/css'>

        <script src="http://www-cs-students.stanford.edu/~tjw/jsbn/jsbn.js"></script>
        <script src="http://www-cs-students.stanford.edu/~tjw/jsbn/jsbn2.js"></script>
        <script src="Scripts/functions.js"></script>
        <script>
        // Variables
        var inputHistory = [];
        var outputHistory = [];

        // Functions dealing with text output
        function outputLine(input) {
        	outputText(input);
        
       		// Add line break at the end
       		var br = document.createElement("br");
       		document.getElementById("output").appendChild(br);
        }

        function outputDoubleLine(input) {
            outputLine(input);
            outputLine("");
        }

        function outputBoldLine(input) {
            var bold = document.createElement("b");
            document.getElementById("output").appendChild(bold).appendChild(document.createTextNode(input));

            // Add line break at the end
            var br = document.createElement("br");
            document.getElementById("output").appendChild(br);
        }

        function outputText(input) {
       		document.getElementById("output").appendChild(document.createTextNode(input));
        }

        function testFunction() {
        	outputFormatted(["input","time","output"]);
        }

        function displayObject(args) {
        	var object = args;

			var output = document.createElement("span");
        	output.setAttribute("class","output");

        	if (object.type == "array") {
        		for (var i = 0; i < object.objects.length; i++) {
        			if (i == 0) {
        				output.appendChild(document.createTextNode("["));
        			}

        			output.appendChild(displayObject(object.objects[i]));

        			if (i == object.objects.length - 1) {
        				output.appendChild(document.createTextNode("]"));
        			} else {
        				output.appendChild(document.createTextNode(","));
        			}
        		}
        	} else if (object.type == "text") {
        		output.appendChild(document.createTextNode(object.value));
        	} else if (object.type == "linedtext") {
        		for (var i = 0; i < object.lines.length; i++) {
        			output.appendChild(displayObject(object.lines[i]));

                    if (i != object.lines.length - 1) {
                        output.appendChild(requestLinebreak());
                    }
        		}
        	} else if (object.type == "code") {
                var code_span = document.createElement("span");
                code_span.setAttribute("class","code");
                code_span.appendChild(document.createTextNode(object.value));
                output.appendChild(code_span);
            } else if (object.type == "canvas") {
				output.appendChild(object.canvas);
        	} else if (object.type == "png") {
        		output.appendChild(object.image);
        	} else if (object.type == "error") {
        		var error_span = document.createElement("span");
        		error_span.setAttribute("class","error");

        		var bold_span = document.createElement("span");
        		bold_span.setAttribute("class","bold");

        		bold_span.appendChild(document.createTextNode("Error: "));
        		error_span.appendChild(bold_span);
        		error_span.appendChild(document.createTextNode(object.message));
        		//error_span.appendChild(requestLinebreak());
        		//error_span.appendChild(document.createTextNode("From: " + object.from));
        		//error_span.appendChild(requestLinebreak());
        		//error_span.appendChild(document.createTextNode("Details: " + object.details));

        		output.appendChild(error_span);
        	}

        	else {
        		var error_span = document.createElement("span");
        		error_span.setAttribute("class","error");

        		var bold_span = document.createElement("span");
        		bold_span.setAttribute("class","bold");

        		bold_span.appendChild(document.createTextNode("Error: "));
        		error_span.appendChild(bold_span);
        		error_span.appendChild(document.createTextNode("Cannot display output"));

        		output.appendChild(error_span);
        	}

        	return output;
        }

        function outputFormatted(args) {
        	var userInput = args[0];
        	var subInput = args[1];
        	var outputContent = args[2];

        	// Output what the user typed in bold
        	var boldText = document.createElement("span");
        	boldText.setAttribute("class","bold");
        	boldText.appendChild(document.createTextNode(userInput));
        	document.getElementById("output").appendChild(boldText);

        	// Output time information next to the user input
        	var subText = document.createElement("span");
        	subText.setAttribute("class","subText");
        	subText.appendChild(document.createTextNode(subInput));
        	document.getElementById("output").appendChild(subText);

        	// Output the actual function output
			
        	var output = displayObject(outputContent);
        	output.appendChild(requestLinebreak());

        	document.getElementById("output").appendChild(requestLinebreak());
       		document.getElementById("output").appendChild(output);

        	// Append two new lines at the end
        	document.getElementById("output").appendChild(requestLinebreak());
        	document.getElementById("output").scrollTop = document.getElementById("output").scrollHeight;
        }

        function requestLinebreak() {
        	return document.createElement("br");
        }

        function clearOutput() {
        	document.getElementById("output").innerHTML = "";
            clearStatus();
        }

        function setStatusMessage(input) {
            setStatus(input + " <a onclick=\"clearStatus()\" href=\"#\">Dismiss</a>");
        }

        function clearStatus() {
            setStatus("");
        }

        function setStatus(input) {
        	document.getElementById("status").innerHTML = input;
        }

        function hideAbout() {
            document.getElementById("about").innerHTML = "<a onclick=\"showAbout()\" href=\"#\">Show</a>";
        }

        function showAbout() {
            document.getElementById("about").innerHTML = "<br>type 'help()' for help<br><a onclick=\"hideAbout()\" href=\"#\">Hide</a>";
        }


        // Parse the input
        function submitInput() {
            var input = document.getElementById("inputField").value;
            var startDate = new Date();

            if (input == "clear()") {
                evaluateNestedFunctions(input);
            } else {
                var output = evaluateNestedFunctions(input);
                var endDate = new Date();
            	var timeDifference = endDate.getTime() - startDate.getTime();

            	outputFormatted([input,timeDifference + " ms",output]);
                inputHistory.push(input);
            }

            // Always execute after a command is submitted
            inputHistoryReset(); // Sets the current history to what is being typed (not something that you would get to from an up/down arrow)
            clearStatus(); // Clears any warning messages
            document.getElementById("inputField").value = ""; // Clears the text field
        }

        var stored_arguments = [];
        var special_char = "$";

        function interpretInput(arg) {
        	var input = arg;
        	input = preprocess(input);
        }

        function processArgument(argument) {
            if (argument.split(",").length > 1) {
                // It is an array
                var arguments = argument.split(",");
                var output = {"type":"array","objects":[]};
                for (var i = 0; i < arguments.length; i++) {
                    if (arguments[i].split(special_char).length > 1) {
                        output.objects.push(stored_arguments[arguments[i].substring(1)]);
                    } else {
                        output.objects.push({"type":"text","value":arguments[i]});
                    }  
                }
            } else {
                // Not an array
                if (argument.split(special_char).length > 1) {
                    var output = {"type":"text","value":stored_arguments[argument.substring(1)]};
                } else {
                    var output = {"type":"text","value":argument};
                }
            }

            stored_arguments.push(output);
            return special_char + (stored_arguments.length - 1);
        }

        function evaluateNestedFunctions(input) {
            var nestedFunction = input.substring(0, input.indexOf(")") + 1);

            // This section gets the nested function to evaluate

            // Split at first comma going back from ( of the function if there is one or
            // Split at first ( going back from ( of the function

            // testing(1,testing(testing(2,3)
            var beforeArguments = nestedFunction.substring(0,nestedFunction.lastIndexOf("(") - 1);
                // testing(1,testing(testing
            
            if (beforeArguments.lastIndexOf(",") > beforeArguments.lastIndexOf("(")) {
            	// There is a comma before the function name
                nestedFunction = nestedFunction.substring(nestedFunction.lastIndexOf(",",nestedFunction.lastIndexOf("(") - 1) + 1);
            } else {
            	// There is a ( before the function name
            	nestedFunction = nestedFunction.substring(nestedFunction.lastIndexOf("(",nestedFunction.lastIndexOf("(") - 1) + 1);
            }

            nestedFunctionBegin = input.indexOf(nestedFunction);
            nestedFunctionEnd = input.indexOf(")");

            // This section evaluates the nested function if the original input has a nested function.
            // If the original input does not have a nested function, it returns the evaluation of the original.

            if (input.split("(").length > 2) {
            	// Original input has a nested function
            	// Evaluate the nested function and replace it with its value, then evaluateNestedFunctions on that
                var firstPart = input.substring(0, nestedFunctionBegin);
                var secondPart = input.substring(nestedFunctionEnd + 1);

                stored_arguments.push(evaluateNestedFunctions(nestedFunction));
                var placeholder = stored_arguments.length - 1;

                return evaluateNestedFunctions(firstPart + special_char + placeholder + secondPart);
            } else {
                // Original input does not have a nested function, so return the original input evaluated.
                if ((input.split(special_char).length == 2) && (input.split(",").length == 1)) {
                    // Function has only one argument and it is in special character notation
                    return evaluateFunction(nestedFunction);
                } else {
                    // Function does not have a special character / is not in one argument form
                    var argument = input.substring(input.substring(0,input.indexOf(")")).lastIndexOf("(") + 1,input.indexOf(")"));

                    var firstPartOfArgument = input.substring(0,input.substring(0,input.indexOf(")")).lastIndexOf("(") + 1);
                    var secondPartOfArgument = input.substring(input.lastIndexOf(")"));

                    return evaluateNestedFunctions(firstPartOfArgument + processArgument(argument) + secondPartOfArgument);
                }
            }         
        }


        function evaluateFunction(input) {
            var functionName = getFunctionName(input);
            var args = getArguments(input);

            if (correctSyntax(input)) {
                    if (functionName == "") {
                        return args;
                    } else if (functionName == "factorial") {
                        return factorial(args);
                    } else if (functionName == "drawPixels") {
                    	return drawPixels(args);
                    } else if (functionName == "mandelbrot") {
                    	return mandelbrot(args);
                    } else if (functionName == "canvas") {
                        return canvas(args);
                    } else if (functionName == "png") {
                        return png(args);
                    } else if (functionName == "sum") {
                        return sum(args);
                    } else if (functionName == "store") {
                        return store(args);
                    } else if (functionName == "read") {
                        return read(args);
                    }


                    else if (functionName == "testing") {
                    	return testing(args);
                    }


                    else if (functionName == "help") {
                        return help(args);
                    } else if (functionName == "clear") {
                        clearOutput();
                        clearStatus();
                        //clearInputHistory();
                        return "";
                    }

                    else {
                        return {"type":"error","message":"Unknown function","from":"function evaluator"};
                    }
                } else {
                    return {"type":"error","message":"Syntax Error","from":"function evaluator"};
                }
                return {"type":"error","message":"Unknown error","from":"function evaluator"};
        }

        function getFunctionName(input) {
            return input.substring(0, input.indexOf("("));
        }
        function getArguments(arg) {
            var input = arg;

            var index_number = parseInt(input.substring(input.indexOf(special_char) + 1, input.lastIndexOf(")")));
            return stored_arguments[index_number];
        }

        // Text field key presses
        function textFieldKeyCheck(event) {
            if (event.keyCode == 13 && correctSyntax(document.getElementById("inputField").value)) {
                submitInput();
            } else if (event.keyCode == 13) {
                fixSyntax();
            }

            else if (event.keyCode == 38) {
                inputHistoryIncrease();
            } else if (event.keyCode == 40) {
                inputHistoryDecrease();
            }

            updateTextFieldStyle();
        }

        function fixSyntax() {
            input = document.getElementById("inputField").value;
            if (input.split("(").length == 1) {
                document.getElementById("inputField").value = document.getElementById("inputField").value + "()";
            } else {
                var times = input.split("(").length - input.split(")").length;
                for (var i = 0; i < times; i++) {
                    document.getElementById("inputField").value = document.getElementById("inputField").value + ")";
                }
            }
        }

        // Text field color changes
        var isFocused = false;
        function updateTextFieldStyle() {
        	isFocused = true;
            var input = document.getElementById("inputField").value;
            if (input == "") {
                // Blue
                document.getElementById("inputField").style.border = '1px solid #38e';
                document.getElementById("inputField").style.color = "#000000"
            } else if (correctSyntax(input)) {
                // Green
                document.getElementById("inputField").style.border = '1px solid #33bb55';
                document.getElementById("inputField").style.color = "#000000"
            } else {
                // Red
                document.getElementById("inputField").style.border = '1px solid #ff0033';
                document.getElementById("inputField").style.color = "#000000"
            }
        }
        function blurTextField() {
        	isFocused = false;
            document.getElementById("inputField").style.border = "1px solid #bbbbbb";
            //document.getElementById("inputField").style.color = "#cccccc"
        }
        function textFieldHoverEffect() {
        	if (!isFocused) {
        		document.getElementById("inputField").style.border = "1px solid #999999";
        	}
        }
        function textFieldUnhoverEffect() {
        	if (!isFocused) {
        		document.getElementById("inputField").style.border = "1px solid #bbbbbb";
        	}
        }

        function correctSyntax(input) {
            if ((input.split("(").length == input.split(")").length) && (input.split("(").length > 1)) {
                return true;
            } else {
                return false;
            }
        }

        // Text field history on up/down arrow
        var current = inputHistory.length; // This is the input history currently viewed.
        var typingInProgress = ""; // This is what the user has typed but has then left by pressing the up arrow.

        function inputHistoryIncrease() {
        	if (current == inputHistory.length) {
                    typingInProgress = document.getElementById("inputField").value;
            }

            if (current > 0) {
                current--;
                document.getElementById("inputField").value = inputHistory[current];
            }
        }
        function inputHistoryDecrease() {
        	if (current == inputHistory.length) {
                    typingInProgress = document.getElementById("inputField").value;
            }

            if (current > inputHistory.length - 2) {
                document.getElementById("inputField").value = typingInProgress;
                inputHistoryReset();
            } else {
                current++;
                document.getElementById("inputField").value = inputHistory[current];
            }
        }
        function inputHistoryReset() {
            current = inputHistory.length;
        }
        function clearInputHistory() {
            inputHistory = [];
        }
        </script>
</head>
<body>
	<h1>nc99 JavaScript Calculator</h1>
	<p>
        Type <span class="code">help()</span> for a list of commands.

        <!--
        <span id="about">
            <a onclick="showAbout()" href="#">Show</a>
        </span>-->
    </p>
    <hr>

    <p id="output">
    </p>

    <p id="status">
    </p>

    <p id="inputFieldSection">
        <input type="text" onkeydown="textFieldKeyCheck(event)" onkeyup="updateTextFieldStyle()" onfocus="updateTextFieldStyle()" onmouseover="textFieldHoverEffect()" onmouseout="textFieldUnhoverEffect()" onblur="blurTextField()" name="inputField" class="inputField" id="inputField" spellcheck="false" autocomplete="off" autofocus>
        <span id="progress">
        </span>
    </p>
    
</body>
</html>
